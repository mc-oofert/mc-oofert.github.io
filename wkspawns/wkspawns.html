<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Wuckle Item Spawns</title>
        <meta name="description" content="Mostly accurate White Knuckle item spawn list" />
        <meta property="og:title" content="Wuckle Item Spawns" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://mc-oofert.github.io/wkspawns/wkspawns.html" />
        <meta property="og:description" content="Mostly accurate White Knuckle item spawn list" />
        <link rel="stylesheet" href="wk.css"/>
        <script src="https://unpkg.com/mithril@2.3.7/mithril.js"></script>
    </head>
    <body>
        <div id="intro"></div>
        <div class="searchcont">
            Search by level name <small>(case-sensitive)</small>: <input type="text" id="searchbar"></input><br/>
            Search by item name <small>(case-sensitive)</small>: <input type="text" id="searchbar2"></input>
        </div>
        <div id="toc"></div>
        <div id="datastuff"></div>
        <script>
            // By no means is this good code but whatever
            var root = document.getElementById("datastuff")
            const intro = document.getElementById("intro");
            const toc = document.getElementById("toc");
            const searchbar = document.getElementById("searchbar");
            const searchbaritem = document.getElementById("searchbar2");
            searchbar.onchange = function() {
                m.redraw();
            }
            searchbaritem.onchange = function() {
                m.redraw();
            }

            var jsonresult;
            try {
                const request = new XMLHttpRequest();
                request.open("GET", "wkpictures/output.json", false);
                request.send(null);
                jsonresult = JSON.parse(request.responseText);
            } catch(error) {
                console.log(error)
                m.render(intro,m("div", {class: "errorbox"},"Loading failed:\n"+error));
            }

            function MakeItemData(item) {
                var chance = item.spawnchance ? item.spawnchance+"%" : "100%"
                return [
                    m("div", {class: "itemName"}, item.name),
                    m("ul", {class: "itemDataSummary"}, [ //
                        m("h3", "Unadjusted chance: ", [m("b", chance), item.spawnchance == null ? m("i", " (probably)") : null]),
                        m("p", {style: "font-weight: normal"}, "Details:"),
                        item.textdata.map(function(dat) {
                            return m("li", {key: dat}, dat)}
                        )
                    ])
                ]
            }
            function ItemImageClicked(event) { //this is stupid i know but this is really just a fancy json and picture site thing
                var isFullbright = event.srcElement.src.includes("-fullbright")
                event.srcElement.parentElement.className = isFullbright ? "itemPictureContainer normal" : "itemPictureContainer fullbright"
                event.srcElement.src = isFullbright ? event.srcElement.src.replace("-fullbright", "") : event.srcElement.src.replace(".jpg", "-fullbright.jpg")
            }

            m.render(intro, [m("p", ["White Knuckle item spawns for version ", m("b", m("i",jsonresult.version)), ". Items may be out of bounds or otherwise invisible. No guarantees. Might contain bad data, still in progress. Does not contain/account for other forms of item spawns."])])
            var ToCComponent = {
                view: function() {
                    try {
                        var tocContents = [];
                        for (let levelIndex = 0; levelIndex < jsonresult.levels.length; ++levelIndex) {
                            const level = jsonresult.levels[levelIndex];
                            if(searchbar.value && !level.levelName.includes(searchbar.value)) {continue;}
                            if(searchbaritem.value) {
                                var containsItem = false;
                                for (let itemIndex = 0; itemIndex < level.items.length; ++itemIndex) {
                                    const item = level.items[itemIndex];
                                    if(searchbaritem.value && !item.name.includes(searchbaritem.value)) {continue;}
                                    containsItem = true;
                                }
                                if(!containsItem) {continue;}
                            }
                            tocContents.push(m("li", m("a", {href: '#' + level.levelName}, level.levelName)))
                        }
                        return m("ul", tocContents);
                    } catch(error) {
                        console.log(error)
                        return m("div", {class: "errorbox"},error);
                    }
                }
            }
            m.mount(toc, ToCComponent);
            var LevelListComp = {
                view: function() {
                    try{
                        var output = []
                        for (let levelIndex = 0; levelIndex < jsonresult.levels.length; ++levelIndex) {
                            const level = jsonresult.levels[levelIndex];
                            const levelName = ""+level.levelName;
                            if(searchbar.value && !levelName.includes(searchbar.value)) {continue;}
                            var levelResult = [];
                            for (let itemIndex = 0; itemIndex < level.items.length; ++itemIndex) {
                                const item = level.items[itemIndex];
                                if(searchbaritem.value && !item.name.includes(searchbaritem.value)) {continue;}
                                levelResult.push(m("tr", [
                                    m("td", [m("div", {class: "itemData"}, MakeItemData(item))]),
                                    m("td", {class: "itemPictureContainer normal"}, [m("img", {class: "itemPicture", src: `wkpictures/${item.id}.jpg`, loading: "lazy", onclick: ItemImageClicked})]),
                                ]))
                            }
                            if(levelResult.length <= 0) {
                                if(!searchbaritem.value) {
                                    output.push(m("h1", {id: levelName}, levelName));
                                    output.push(m("p", {class: "noitemstext"}, "No items found in this level..."));
                                }
                                continue;
                            }
                            output.push(m("h1", {id: levelName}, levelName));
                            output.push(m("div", {class: "tablecontainer"}, m("table", {cellspacing: "1"}, levelResult)));
                        }
                        
                        return m("div", output);
                    } catch(error) {
                        console.log(error)
                        return m("div", {class: "errorbox"},error);
                    }
                }
            }
            m.mount(root, LevelListComp);
        </script>
    </body>
</html>